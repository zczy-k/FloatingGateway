# 发布验证清单

本清单用于验证自动发布和自动升级系统是否正常工作。

## ✅ 自动发布工作流验证

### 1. 工作流配置
- [x] `.github/workflows/auto-release.yml` 文件存在
- [x] 配置了正确的触发条件（push to main）
- [x] 配置了 paths-ignore（忽略文档文件）
- [x] 配置了 contents: write 权限

### 2. 版本号管理
- [x] 实现了版本号自动计算逻辑
- [x] 支持根据提交信息决定版本增长策略
  - [x] feat/feature/新功能/添加 → minor
  - [x] break/breaking/重大变更 → major
  - [x] 其他 → patch
- [x] 避免重复发布（检查 commit 是否已有 tag）

### 3. 构建配置
- [x] Agent 构建配置（5个架构）
  - [x] linux-amd64
  - [x] linux-arm64
  - [x] linux-arm
  - [x] linux-mips
  - [x] linux-mipsle
- [x] Controller 构建配置（5个平台）
  - [x] linux-amd64
  - [x] linux-arm64
  - [x] darwin-amd64
  - [x] darwin-arm64
  - [x] windows-amd64
- [x] 版本号通过 ldflags 注入

### 4. Release 创建
- [x] 自动生成 Release Notes
- [x] 上传所有二进制文件
- [x] 生成 SHA256 校验和
- [x] 创建 GitHub Release

## ✅ Controller 自动升级功能验证

### 1. API 端点
- [x] `GET /api/version` - 版本检查 API
  - [x] 返回当前版本
  - [x] 返回最新版本
  - [x] 返回是否有更新
  - [x] 返回 Release URL 和 Notes
- [x] `POST /api/upgrade` - 自动升级 API
  - [x] 接收目标版本参数
  - [x] 验证版本格式
  - [x] 后台执行升级
  - [x] 返回升级状态

### 2. 版本检查逻辑
- [x] 调用 GitHub API 获取最新 Release
- [x] 版本号比较逻辑正确
- [x] 处理 "dev" 版本
- [x] 错误处理完善

### 3. 升级逻辑
- [x] 根据 OS 和架构确定二进制文件名
- [x] 支持多个下载源（加速镜像）
  - [x] 用户配置的代理
  - [x] 内置加速镜像列表
  - [x] 直接下载（fallback）
- [x] 下载到临时文件
- [x] 验证文件大小
- [x] 备份旧文件
- [x] 替换二进制文件
- [x] 自动重启服务

### 4. Web UI 集成
- [x] "检查更新"按钮
- [x] 版本信息模态框
- [x] "自动升级"按钮
- [x] 升级进度提示
- [x] 错误处理和提示

## ✅ Agent 自动安装最新版本验证

### 1. 安装脚本
- [x] `setup.sh` 使用 latest/download URL
- [x] `scripts/controller.sh` 调用 GitHub API
- [x] `scripts/router.sh` 调用 GitHub API
- [x] 所有脚本支持加速镜像

### 2. Go 代码安装
- [x] `internal/controller/manager.go` 中的下载逻辑
- [x] 使用 latest/download URL
- [x] 支持多个加速镜像
- [x] 自动重试机制
- [x] 文件完整性验证

### 3. 缓存机制
- [x] 本地缓存已下载的二进制文件
- [x] 避免重复下载
- [x] 缓存目录管理

## 🧪 测试场景

### 场景 1: 首次发布
1. 推送代码到 main 分支
2. 工作流自动触发
3. 创建 v1.0.8 版本（基于当前 v1.0.7）
4. 构建所有平台二进制文件
5. 创建 GitHub Release

**预期结果**: 
- GitHub Actions 成功运行
- Release 页面出现新版本
- 所有二进制文件可下载

### 场景 2: Controller 自动升级
1. 打开 Web UI
2. 点击"检查更新"
3. 显示新版本信息
4. 点击"自动升级"
5. 等待服务重启

**预期结果**:
- 成功下载新版本
- 服务自动重启
- 版本号更新

### 场景 3: Agent 自动安装
1. 在 Web UI 中添加路由器
2. 点击"安装 Agent"
3. 观察安装日志

**预期结果**:
- 自动下载最新版本 Agent
- 安装成功
- 版本号显示为最新

### 场景 4: 版本号策略
1. 提交信息: "修复: 某个 bug"
   - 预期: v1.0.7 → v1.0.8
2. 提交信息: "新功能: 添加某功能"
   - 预期: v1.0.8 → v1.1.0
3. 提交信息: "重大变更: API 不兼容"
   - 预期: v1.1.0 → v2.0.0

**预期结果**:
- 版本号按预期增长

## 📊 监控指标

### GitHub Actions
- [ ] 工作流运行成功率
- [ ] 构建时间
- [ ] 发布频率

### 下载统计
- [ ] Release 下载次数
- [ ] 各平台下载分布
- [ ] 加速镜像使用率

### 升级成功率
- [ ] Controller 升级成功率
- [ ] Agent 安装成功率
- [ ] 错误类型分布

## 🔧 故障排查

### 工作流失败
1. 查看 GitHub Actions 日志
2. 检查构建错误
3. 验证权限配置
4. 检查 Go 版本兼容性

### 升级失败
1. 检查网络连接
2. 验证 GitHub API 可访问性
3. 检查磁盘空间
4. 查看 Controller 日志

### 版本号错误
1. 检查提交信息格式
2. 查看版本计算日志
3. 验证 Git 标签
4. 手动修正标签

## 📝 改进建议

### 短期
- [ ] 添加升级前的备份确认
- [ ] 实现升级回滚功能
- [ ] 添加升级进度条
- [ ] 支持离线升级包

### 中期
- [ ] 实现增量更新
- [ ] 添加版本兼容性检查
- [ ] 支持自定义下载源
- [ ] 实现自动回滚机制

### 长期
- [ ] 实现 A/B 升级
- [ ] 支持灰度发布
- [ ] 添加升级统计分析
- [ ] 实现自动化测试流程

## 🎯 下一步行动

1. **立即执行**
   - [x] 推送代码触发首次自动发布
   - [ ] 验证 Release 创建成功
   - [ ] 测试 Controller 自动升级
   - [ ] 测试 Agent 自动安装

2. **本周完成**
   - [ ] 监控首批用户升级情况
   - [ ] 收集反馈和问题
   - [ ] 优化下载速度
   - [ ] 完善错误提示

3. **本月完成**
   - [ ] 实现升级回滚功能
   - [ ] 添加升级统计
   - [ ] 优化用户体验
   - [ ] 编写用户指南

## ✨ 成功标准

- ✅ 工作流自动触发并成功运行
- ✅ Release 自动创建并包含所有文件
- ✅ Controller 可以一键升级
- ✅ Agent 自动安装最新版本
- ✅ 版本号策略正确执行
- ✅ 下载加速正常工作
- ✅ 错误处理完善
- ✅ 用户体验流畅

---

**最后更新**: 2026-02-09
**状态**: ✅ 系统已完成并准备就绪
