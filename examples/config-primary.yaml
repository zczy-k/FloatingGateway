# Example configuration for PRIMARY router (backup gateway)
# This router takes over only when the secondary router fails its health checks.
#
# Deploy to: /etc/gateway-agent/config.yaml on the primary router

version: 1
role: primary

lan:
  # Network interface connected to LAN
  iface: br-lan  # OpenWrt typically uses br-lan
  # CIDR is auto-detected from interface if not specified
  # cidr: 192.168.1.0/24
  
  # Virtual IP - the gateway address all clients will use
  # MUST be the same on both routers and NOT used by any other device
  vip: 192.168.1.1

routers:
  # Self IP is auto-detected from interface if not specified
  # self_ip: 192.168.1.2
  
  # IP address of the secondary (peer) router
  peer_ip: 192.168.1.3

keepalived:
  # Virtual Router ID - must be same on both routers, unique on network
  vrid: 51
  # Advertisement interval in seconds
  advert_int: 1
  # Priority settings
  priority:
    primary: 100    # Lower priority = backup
    secondary: 150  # Higher priority = preferred master

failover:
  # Which role should be master when both are healthy
  prefer: secondary
  # Allow higher priority router to reclaim master
  preempt: true
  # Delay before preemption (allows for flapping prevention)
  preempt_delay_sec: 30

health:
  # Health check mode:
  # - basic: check local connectivity (ping domestic DNS)
  # - internet: check international connectivity (for proxy/VPN scenarios)
  mode: basic  # Primary typically just needs basic connectivity
  
  # How often to run health checks
  interval_sec: 2
  # Consecutive failures before marking unhealthy
  fail_count: 3
  # Consecutive successes before marking healthy again
  recover_count: 5
  # Minimum hold-down time before allowing recovery
  hold_down_sec: 10
  
  # Basic mode checks (domestic connectivity)
  basic:
    checks:
      - type: ping
        target: 223.5.5.5  # Alibaba DNS
        timeout: 3
      - type: dns
        resolver: 223.5.5.5
        domain: baidu.com
        timeout: 3

  # Internet mode checks (not used for primary with basic mode)
  internet:
    checks:
      - type: ping
        target: 1.1.1.1
        timeout: 3
      - type: dns
        resolver: 1.1.1.1
        domain: google.com
        timeout: 3
      - type: tcp
        target: 1.1.1.1
        port: 443
        timeout: 3

# OpenWrt-specific settings
openwrt:
  dhcp:
    # Automatically update DHCP gateway option
    # Only enable if you want DHCP clients to automatically use the VIP
    auto_set_gateway: false
