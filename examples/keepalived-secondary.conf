# keepalived.conf 样例 - Secondary 路由器 (Ubuntu/Linux)
# 此配置由 gateway-agent apply 自动生成
# 路径: /etc/keepalived/keepalived.conf
#
# 说明:
# - Secondary 作为首选网关，优先级较高 (150)
# - 健康时作为 MASTER 持有 VIP
# - 国际链路故障时，权重 -200 使优先级降为 -50，低于 Primary (100)
# - 此时 Primary 接管 VIP

global_defs {
    router_id GATEWAY_SECONDARY
    script_user root
    enable_script_security
}

# 健康检查脚本 - 检测国际链路
vrrp_script chk_gateway {
    # 调用 gateway-agent 执行健康检查
    # mode=internet: 检测国际链路（1.1.1.1, google.com 等）
    # 返回 0 = 健康，非 0 = 不健康
    script "/usr/bin/gateway-agent check --mode=internet"
    interval 2          # 检查间隔（秒）
    weight -200         # 关键：不健康时优先级 -200，使 150-200=-50 < 100
    fall 3              # 连续失败次数判定为故障
    rise 5              # 连续成功次数判定为恢复
}

vrrp_instance VI_GATEWAY {
    state MASTER                    # 初始状态（实际由优先级决定）
    interface eth0                  # LAN 接口（根据实际情况修改）
    virtual_router_id 51            # VRID (1-255)，两台路由器必须相同
    priority 150                    # 优先级：Secondary 较高（健康时为 MASTER）
    advert_int 1                    # VRRP 通告间隔（秒）
    
    # 抢占模式配置
    preempt_delay 30                # 恢复后等待 30 秒再抢占，防止抖动
    
    # 认证（可选，两端必须一致）
    authentication {
        auth_type PASS
        auth_pass gateway123
    }
    
    # 虚拟 IP（VIP）
    virtual_ipaddress {
        192.168.1.1/24 dev eth0     # VIP 地址（示例，请替换）
    }
    
    # 关联健康检查脚本
    track_script {
        chk_gateway
    }
    
    # 状态变更通知脚本
    notify_master "/usr/bin/gateway-agent notify master"
    notify_backup "/usr/bin/gateway-agent notify backup"
    notify_fault "/usr/bin/gateway-agent notify fault"
}
