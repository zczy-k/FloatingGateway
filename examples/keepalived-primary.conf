# keepalived.conf 样例 - Primary 路由器 (OpenWrt)
# 此配置由 gateway-agent apply 自动生成
# 路径: /etc/keepalived/keepalived.conf
#
# 说明:
# - Primary 作为备份网关，优先级较低 (100)
# - 当 Secondary 健康时，Primary 处于 BACKUP 状态
# - 当 Secondary 故障时，Primary 接管 VIP 成为 MASTER

global_defs {
    router_id GATEWAY_PRIMARY
    script_user root
    enable_script_security
}

# 健康检查脚本
vrrp_script chk_gateway {
    # 调用 gateway-agent 执行健康检查
    # 返回 0 = 健康，非 0 = 不健康
    script "/usr/bin/gateway-agent check --mode=basic"
    interval 2          # 检查间隔（秒）
    weight 0            # Primary 不需要权重调整
    fall 3              # 连续失败次数判定为故障
    rise 5              # 连续成功次数判定为恢复
}

vrrp_instance VI_GATEWAY {
    state BACKUP                    # 初始状态（实际由优先级决定）
    interface br-lan                # LAN 接口（OpenWrt 通常是 br-lan）
    virtual_router_id 51            # VRID (1-255)，两台路由器必须相同
    priority 100                    # 优先级：Primary 较低
    advert_int 1                    # VRRP 通告间隔（秒）
    
    # 认证（可选，两端必须一致）
    authentication {
        auth_type PASS
        auth_pass gateway123
    }
    
    # 虚拟 IP（VIP）
    virtual_ipaddress {
        192.168.1.1/24 dev br-lan   # VIP 地址（示例，请替换）
    }
    
    # 关联健康检查脚本
    track_script {
        chk_gateway
    }
    
    # 状态变更通知脚本
    notify_master "/usr/bin/gateway-agent notify master"
    notify_backup "/usr/bin/gateway-agent notify backup"
    notify_fault "/usr/bin/gateway-agent notify fault"
}
